{"mappings":"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","sources":["proxy/factory/index.ts"],"sourcesContent":["// import { polyfillKeys } from \"@portal-solutions/semble-common\";\nimport {\n  isPolyfillKey,\n  protoChained as protoChainedCommon,\n} from \"@portal-solutions/semble-common\";\nimport { descGet, descSet, desc } from \"@portal-solutions/semble-common\";\nexport type FactoryOpts = {\n  WeakMap?: typeof WeakMap;\n  Function?: typeof Function;\n  Object?: typeof Object;\n};\nexport default function create(opts: FactoryOpts = {}): {\n  Proxy: typeof globalThis.Proxy;\n  Reflect: typeof globalThis.Reflect;\n  WeakMap: typeof WeakMap;\n} {\n  const _WeakMap = opts.WeakMap ?? globalThis.WeakMap;\n  const { Function = globalThis.Function, Object = globalThis.Object } = opts;\n  const oldDefineProperty = Object.defineProperty.bind(Object);\n  const _proxyData: WeakMap<any, { object: any; handler: ProxyHandler<any> }> =\n    new _WeakMap();\n\n  function protoChained<\n    T extends object,\n    X extends keyof T,\n    U,\n    Args extends unknown[]\n  >(\n    f: <T2 extends { [X2 in X]: any }>(t: T2, key: X, ...args: Args) => U,\n    {\n      Reflect = _Reflect,\n    }: {\n      Reflect?: {\n        getPrototypeOf: typeof globalThis.Reflect.getPrototypeOf;\n        getOwnPropertyDescriptor: typeof globalThis.Reflect.getOwnPropertyDescriptor;\n      };\n    } = {}\n  ): (val: T, key: X, ...args: Args) => U {\n    return protoChainedCommon(f, { Reflect });\n  }\n  let ospo: typeof Reflect.setPrototypeOf;\n  const _Reflect: typeof Reflect = {\n    apply: Function.prototype.apply.call.bind(Function.prototype.apply),\n    construct: (target, args, self) =>\n      _proxyData.has(target) && \"construct\" in _proxyData.get(target)!.handler!\n        ? _proxyData.get(target)!.handler.construct!(\n            _proxyData.get(target)!.object,\n            args,\n            self\n          )\n        : target === self\n        ? new target(...args)\n        : _Reflect.apply(target, self, args),\n    get: protoChained((object, key) =>\n      _proxyData.has(object) &&\n      \"get\" in _proxyData.get(object)!.handler &&\n      !isPolyfillKey(key)\n        ? _proxyData.get(object)!.handler.get!(\n            _proxyData.get(object)!.object,\n            key,\n            object\n          )\n        : descGet(object, key)\n    ),\n    set: protoChained((object, key, value) =>\n      _proxyData.has(object) &&\n      \"set\" in _proxyData.get(object)!.handler &&\n      !isPolyfillKey(key)\n        ? _proxyData.get(object)!.handler.set!(\n            _proxyData.get(object)!.object,\n            key,\n            value,\n            object\n          )\n        : (descSet(object, key, value as any), true)\n    ),\n    has: protoChained((object, key) =>\n      _proxyData.has(object) &&\n      \"has\" in _proxyData.get(object)!.handler &&\n      !isPolyfillKey(key)\n        ? _proxyData.get(object)!.handler.has!(\n            _proxyData.get(object)!.object,\n            key\n          )\n        : desc(object, key) !== null\n    ),\n\n    setPrototypeOf: (ospo = ((old, object, proto) => (\n      old(object, proto), true\n    )).bind(\n      null,\n      \"setPrototypeOf\" in Object\n        ? Object.setPrototypeOf.bind(Object)\n        : (object, proto) => ((object.__proto__ = proto), object)\n    )),\n  } as any;\n  function reflectProp(obj: any, key: keyof any): PropertyDescriptor {\n    return {\n      get: () => _Reflect.get(obj, key, obj),\n      set: (v) => _Reflect.set(obj, key, v, obj),\n      enumerable: false,\n      configurable: false,\n    };\n  }\n  const _Proxy: typeof Proxy = class ProxyTemp extends Function {\n    static __call = Function.prototype.call.call.bind(Function.prototype.call);\n    constructor(object, handler: ProxyHandler<any>) {\n      if (false) super(); //Obey TS\n      const m = ProxyTemp.__create(object, handler);\n      ospo(m, ProxyTemp.prototype);\n      return m;\n    }\n    static __link(proxy) {\n      const { object } = _proxyData.get(proxy)!;\n      for (const prop in object)\n        try {\n          oldDefineProperty(object, prop, reflectProp(object, prop));\n        } catch {}\n    }\n    static __create(object, handler: ProxyHandler<any>) {\n      const fn = function (...args) {\n        if (this instanceof fn) {\n          if (\"construct\" in handler) {\n            return handler.construct!(object, args, new.target);\n          }\n          return new object(...args);\n        } else {\n          if (\"apply\" in handler) {\n            return handler.apply!(object, this, args);\n          }\n          return ProxyTemp.__call(object, this, ...args);\n        }\n      };\n      _proxyData.set(fn, { object, handler });\n      ProxyTemp.__link(fn);\n      return fn;\n    }\n    static {\n      for (const trap of [\n        \"defineProperty\",\n        \"getOwnPropertyDescriptor\",\n        \"getOwnPropertyDescriptors\",\n        \"freeze\",\n        \"seal\",\n        \"preventExtensions\",\n        \"getPrototypeOf\",\n        \"setPrototypeOf\",\n      ]) {\n        if (trap in Object) {\n          _Reflect[trap] = new ProxyTemp(\n            trap in _Reflect ? _Reflect[trap] : Object[trap].bind(Object),\n            {\n              apply(target, self, args) {\n                if (_proxyData.has(args[0])) {\n                  if (trap in _proxyData.get(args[0])?.handler!) {\n                    return _proxyData.get(args[0])?.handler?.[trap]?.(...args);\n                  } else {\n                    args[0] = _proxyData.get(args[0])!.object;\n                    return _Reflect.apply(target, self, args);\n                  }\n                } else {\n                  return _Reflect.apply(target, self, args);\n                }\n              },\n            }\n          );\n          Object[trap] = new ProxyTemp(Object[trap], {\n            apply(target, self, args) {\n              if (_proxyData.has(args[0])) {\n                if (trap in _proxyData.get(args[0])?.handler!) {\n                  return _proxyData.get(args[0])?.handler?.[trap]?.(...args);\n                } else {\n                  args[0] = _proxyData.get(args[0])!.object;\n                  return _Reflect.apply(target, self, args);\n                }\n              } else {\n                return _Reflect.apply(target, self, args);\n              }\n            },\n          });\n        }\n      }\n      Function.prototype.toString = new ProxyTemp(Function.prototype.toString, {\n        apply(target, thisArg, argArray) {\n          while (_proxyData.has(thisArg))\n            thisArg = _proxyData.get(thisArg)!.object;\n          return _Reflect.apply(target, thisArg, argArray);\n        },\n      }) as any;\n    }\n  } as any;\n  return { Proxy: _Proxy, Reflect: _Reflect, WeakMap: _WeakMap };\n}\n"],"names":[],"version":3,"file":"index.js.map"}