{"mappings":"AAqCA,OAAO,MAAM,UAAU,OAAO,OA0Df,CAAC;AAChB,OAAO,MAAM,QAAQ,OAAO,KA0Fb,CAAC","sources":["proxy/proxy/index.ts","proxy/index.ts"],"sourcesContent":[null,"import { _WeakMap } from \"@portal-solutions/semble-weak-map\";\n// import { polyfillKeys } from \"@portal-solutions/semble-common\";\nimport { isPolyfillKey } from \"@portal-solutions/semble-common\";\nimport { descGet, descSet, desc } from \"@portal-solutions/semble-common\";\n\nconst _proxyData: WeakMap<any, { object: any; handler: ProxyHandler<any> }> =\n  new _WeakMap();\nfunction protoChain<\n  T extends object,\n  X extends keyof T,\n  U,\n  Args extends unknown[]\n>(\n  val: T,\n  key: X,\n  f: <T2 extends { [X2 in X]: any }>(t: T2, key: X, ...args: Args) => U,\n  ...args: Args\n): U {\n  while (1) {\n    if (_Reflect.getOwnPropertyDescriptor(val, key)) {\n      return f(val, key, ...args);\n    }\n    val = _Reflect.getPrototypeOf(val) as T; //Simulate tail recursion\n  }\n  throw ``;\n}\nfunction protoChained<\n  T extends object,\n  X extends keyof T,\n  U,\n  Args extends unknown[]\n>(\n  f: <T2 extends { [X2 in X]: any }>(t: T2, key: X, ...args: Args) => U\n): (val: T, key: X, ...args: Args) => U {\n  return (val, key, ...args) => protoChain(val, key, f, ...args);\n}\n\nexport const _Reflect: typeof Reflect =\n  \"Reflect\" in globalThis\n    ? globalThis.Reflect\n    : ({\n        apply: Function.prototype.apply.call.bind(Function.prototype.apply),\n        construct: (target, args, self) =>\n          _proxyData.has(target) &&\n          \"construct\" in _proxyData.get(target)!.handler!\n            ? _proxyData.get(target)!.handler.construct!(\n                _proxyData.get(target)!.object,\n                args,\n                self\n              )\n            : target === self\n            ? new target(...args)\n            : _Reflect.apply(target, self, args),\n        get: protoChained((object, key) =>\n          _proxyData.has(object) &&\n          \"get\" in _proxyData.get(object)!.handler &&\n          !isPolyfillKey(key)\n            ? _proxyData.get(object)!.handler.get!(\n                _proxyData.get(object)!.object,\n                key,\n                object\n              )\n            : descGet(object, key)\n        ),\n        set: protoChained((object, key, value) =>\n          _proxyData.has(object) &&\n          \"set\" in _proxyData.get(object)!.handler &&\n          !isPolyfillKey(key)\n            ? _proxyData.get(object)!.handler.set!(\n                _proxyData.get(object)!.object,\n                key,\n                value,\n                object\n              )\n            : (descSet(object, key, value), true)\n        ),\n        has: protoChained((object, key) =>\n          _proxyData.has(object) &&\n          \"has\" in _proxyData.get(object)!.handler &&\n          !isPolyfillKey(key)\n            ? _proxyData.get(object)!.handler.has!(\n                _proxyData.get(object)!.object,\n                key\n              )\n            : desc(object, key) !== null\n        ),\n\n        setPrototypeOf: ((old, object, proto) => (\n          old(object, proto), true\n        )).bind(\n          null,\n          \"setPrototypeOf\" in Object\n            ? Object.setPrototypeOf.bind(Object)\n            : (object, proto) => ((object.__proto__ = proto), object)\n        ),\n      } as any);\nexport const _Proxy: typeof Proxy =\n  \"Proxy\" in globalThis\n    ? globalThis.Proxy\n    : (class ProxyTemp extends Function {\n        static __call = Function.prototype.call.call.bind(\n          Function.prototype.call\n        );\n        constructor(object, handler: ProxyHandler<any>) {\n          if (false) super(); //Obey TS\n          const m = ProxyTemp.__create(object, handler);\n          _Reflect.setPrototypeOf(m, ProxyTemp.prototype);\n          return m;\n        }\n        static __create(object, handler: ProxyHandler<any>) {\n          const fn = function (...args) {\n            if (this instanceof fn) {\n              if (\"construct\" in handler) {\n                return handler.construct!(object, args, this);\n              }\n              return new object(...args);\n            } else {\n              if (\"apply\" in handler) {\n                return handler.apply!(object, this, args);\n              }\n              return ProxyTemp.__call(object, this, ...args);\n            }\n          };\n          _proxyData.set(fn, { object, handler });\n          return fn;\n        }\n        static {\n          for (const trap of [\n            \"defineProperty\",\n            \"getOwnPropertyDescriptor\",\n            \"getOwnPropertyDescriptors\",\n            \"freeze\",\n            \"seal\",\n            \"preventExtensions\",\n            \"getPrototypeOf\",\n            \"setPrototypeOf\",\n          ]) {\n            if (trap in Object) {\n              _Reflect[trap] = new ProxyTemp(\n                trap in _Reflect ? _Reflect[trap] : Object[trap].bind(Object),\n                {\n                  apply(target, self, args) {\n                    if (_proxyData.has(args[0])) {\n                      if (trap in _proxyData.get(args[0])?.handler!) {\n                        return _proxyData\n                          .get(args[0])\n                          ?.handler?.[trap]?.(...args);\n                      } else {\n                        args[0] = _proxyData.get(args[0])!.object;\n                        return _Reflect.apply(target, self, args);\n                      }\n                    } else {\n                      return _Reflect.apply(target, self, args);\n                    }\n                  },\n                }\n              );\n              Object[trap] = new ProxyTemp(Object[trap], {\n                apply(target, self, args) {\n                  if (_proxyData.has(args[0])) {\n                    if (trap in _proxyData.get(args[0])?.handler!) {\n                      return _proxyData\n                        .get(args[0])\n                        ?.handler?.[trap]?.(...args);\n                    } else {\n                      args[0] = _proxyData.get(args[0])!.object;\n                      return _Reflect.apply(target, self, args);\n                    }\n                  } else {\n                    return _Reflect.apply(target, self, args);\n                  }\n                },\n              });\n            }\n          }\n          Function.prototype.toString = new ProxyTemp(\n            Function.prototype.toString,\n            {\n              apply(target, thisArg, argArray) {\n                while (_proxyData.has(thisArg))\n                  thisArg = _proxyData.get(thisArg)!.object;\n                return _Reflect.apply(target, thisArg, argArray);\n              },\n            }\n          ) as any;\n        }\n      } as any);\n"],"names":[],"version":3,"file":"index.d.ts.map"}