{"mappings":"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","sources":["proxy/index.ts"],"sourcesContent":["import { _WeakMap } from \"@portal-solutions/semble-weak-map\";\n// import { polyfillKeys } from \"@portal-solutions/semble-common\";\nimport { isPolyfillKey } from \"@portal-solutions/semble-common\";\nimport { descGet, descSet, desc } from \"@portal-solutions/semble-common\";\n\nconst _proxyData: WeakMap<any, { object: any; handler: ProxyHandler<any> }> =\n  new _WeakMap();\nfunction protoChain<\n  T extends object,\n  X extends keyof T,\n  U,\n  Args extends unknown[]\n>(\n  val: T,\n  key: X,\n  f: <T2 extends { [X2 in X]: any }>(t: T2, key: X, ...args: Args) => U,\n  ...args: Args\n): U {\n  while (1) {\n    if (_Reflect.getOwnPropertyDescriptor(val, key)) {\n      return f(val, key, ...args);\n    }\n    val = _Reflect.getPrototypeOf(val) as T; //Simulate tail recursion\n  }\n  throw ``;\n}\nfunction protoChained<\n  T extends object,\n  X extends keyof T,\n  U,\n  Args extends unknown[]\n>(\n  f: <T2 extends { [X2 in X]: any }>(t: T2, key: X, ...args: Args) => U\n): (val: T, key: X, ...args: Args) => U {\n  return (val, key, ...args) => protoChain(val, key, f, ...args);\n}\n\nexport const _Reflect: typeof Reflect =\n  \"Reflect\" in globalThis\n    ? globalThis.Reflect\n    : ({\n        apply: Function.prototype.apply.call.bind(Function.prototype.apply),\n        construct: (target, args, self) =>\n          _proxyData.has(target) &&\n          \"construct\" in _proxyData.get(target)!.handler!\n            ? _proxyData.get(target)!.handler.construct!(\n                _proxyData.get(target)!.object,\n                args,\n                self\n              )\n            : target === self\n            ? new target(...args)\n            : _Reflect.apply(target, self, args),\n        get: protoChained((object, key) =>\n          _proxyData.has(object) &&\n          \"get\" in _proxyData.get(object)!.handler &&\n          !isPolyfillKey(key)\n            ? _proxyData.get(object)!.handler.get!(\n                _proxyData.get(object)!.object,\n                key,\n                object\n              )\n            : descGet(object, key)\n        ),\n        set: protoChained((object, key, value) =>\n          _proxyData.has(object) &&\n          \"set\" in _proxyData.get(object)!.handler &&\n          !isPolyfillKey(key)\n            ? _proxyData.get(object)!.handler.set!(\n                _proxyData.get(object)!.object,\n                key,\n                value,\n                object\n              )\n            : (descSet(object, key, value), true)\n        ),\n        has: protoChained((object, key) =>\n          _proxyData.has(object) &&\n          \"has\" in _proxyData.get(object)!.handler &&\n          !isPolyfillKey(key)\n            ? _proxyData.get(object)!.handler.has!(\n                _proxyData.get(object)!.object,\n                key\n              )\n            : desc(object, key) !== null\n        ),\n\n        setPrototypeOf: ((old, object, proto) => (\n          old(object, proto), true\n        )).bind(\n          null,\n          \"setPrototypeOf\" in Object\n            ? Object.setPrototypeOf.bind(Object)\n            : (object, proto) => ((object.__proto__ = proto), object)\n        ),\n      } as any);\nexport const _Proxy: typeof Proxy =\n  \"Proxy\" in globalThis\n    ? globalThis.Proxy\n    : (class ProxyTemp extends Function {\n        static __call = Function.prototype.call.call.bind(\n          Function.prototype.call\n        );\n        constructor(object, handler: ProxyHandler<any>) {\n          if (false) super(); //Obey TS\n          const m = ProxyTemp.__create(object, handler);\n          _Reflect.setPrototypeOf(m, ProxyTemp.prototype);\n          return m;\n        }\n        static __create(object, handler: ProxyHandler<any>) {\n          const fn = function (...args) {\n            if (this instanceof fn) {\n              if (\"construct\" in handler) {\n                return handler.construct!(object, args, this);\n              }\n              return new object(...args);\n            } else {\n              if (\"apply\" in handler) {\n                return handler.apply!(object, this, args);\n              }\n              return ProxyTemp.__call(object, this, ...args);\n            }\n          };\n          _proxyData.set(fn, { object, handler });\n          return fn;\n        }\n        static {\n          for (const trap of [\n            \"defineProperty\",\n            \"getOwnPropertyDescriptor\",\n            \"getOwnPropertyDescriptors\",\n            \"freeze\",\n            \"seal\",\n            \"preventExtensions\",\n            \"getPrototypeOf\",\n            \"setPrototypeOf\",\n          ]) {\n            if (trap in Object) {\n              _Reflect[trap] = new ProxyTemp(\n                trap in _Reflect ? _Reflect[trap] : Object[trap].bind(Object),\n                {\n                  apply(target, self, args) {\n                    if (_proxyData.has(args[0])) {\n                      if (trap in _proxyData.get(args[0])?.handler!) {\n                        return _proxyData\n                          .get(args[0])\n                          ?.handler?.[trap]?.(...args);\n                      } else {\n                        args[0] = _proxyData.get(args[0])!.object;\n                        return _Reflect.apply(target, self, args);\n                      }\n                    } else {\n                      return _Reflect.apply(target, self, args);\n                    }\n                  },\n                }\n              );\n              Object[trap] = new ProxyTemp(Object[trap], {\n                apply(target, self, args) {\n                  if (_proxyData.has(args[0])) {\n                    if (trap in _proxyData.get(args[0])?.handler!) {\n                      return _proxyData\n                        .get(args[0])\n                        ?.handler?.[trap]?.(...args);\n                    } else {\n                      args[0] = _proxyData.get(args[0])!.object;\n                      return _Reflect.apply(target, self, args);\n                    }\n                  } else {\n                    return _Reflect.apply(target, self, args);\n                  }\n                },\n              });\n            }\n          }\n          Function.prototype.toString = new ProxyTemp(\n            Function.prototype.toString,\n            {\n              apply(target, thisArg, argArray) {\n                while (_proxyData.has(thisArg))\n                  thisArg = _proxyData.get(thisArg)!.object;\n                return _Reflect.apply(target, thisArg, argArray);\n              },\n            }\n          ) as any;\n        }\n      } as any);\n"],"names":[],"version":3,"file":"index.js.map"}